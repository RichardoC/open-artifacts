<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon">
    <meta name="viewport" content="initial-scale=0.75">
    <title>OpenArtifacts</title>
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        .logo {
            font-size: 30px;
            margin-bottom: 3px;
            padding-right: 10px;
        }

        .credits {
            text-align: right;
            font-size: 20px;
            line-height: 30px;
        }

        a,
        a:visited {
            color: #105c64;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        iframe {
            width: calc(100% - 20px);
            height: calc(100% - 30px);
            margin: 9px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }


        .form-group {
            display: flex;
            align-items: top;
            margin-bottom: 5px;
            font-family: Arial, sans-serif;
        }

        .form-group label {
            width: 150px;
            margin-right: 10px;
            margin-top: 3px;
            text-align: right;
        }

        .form-group input,
        .form-group textarea {
            flex: 1;
            padding: 5px 10px;
            border: none;
            border-bottom: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            color: #333;
        }

        .form-group textarea {
            resize: vertical;
            font-size: 14px;
            color: #000;
        }

        .form-group button {
            margin-left: 160px;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
        }

        .form-group button:hover {
            background-color: #45a049;
        }


        .tab-section {
            display: none;
            height: 100%;
        }

        .tab-section.current {
            display: block;
        }

        .tabs {
            display: flex;
            justify-content: left;
            border-bottom: 1px solid #ccc;
            padding: 0 50px;
            margin-bottom: 20px;
            padding-top: 10px;
            background-color: #f1f1f1;
        }

        .tab-btn {
            padding: 0px 20px;
            font-size: 15px;
            color: #333;
            border: 1px solid #ccc;
            border-bottom: none;
            background-color: #e3e2e1;
            cursor: pointer;
            margin-right: 2px;
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
        }

        .tab-btn.current {
            background-color: #fff;
            border-bottom: none;
            position: relative;
            top: 1px;
        }

        #tab-code pre {
            margin: 10px;
            padding: 10px;

            width: calc(100% - 40px);
            height: calc(100% - 50px);
            overflow: auto;

            background-color: #f1f1f1;
            border-radius: 5px;
            border: 1px solid #ccc;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        #tab-form {
            padding: 20px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="tabs">
            <div class='logo'> OpenArtifacts</div>
            <button class="tab-btn current" id="button-tab-form" onclick="openTab('tab-form')">Form</button>
            <button class="tab-btn" id="button-tab-code" onclick="openTab('tab-code')">Code</button>
            <button class="tab-btn" id="button-tab-app" onclick="openTab('tab-app')">App</button>
        </div>

        <div class="tab-section current" id="tab-form">
            <form id="api-form">
                <div class="form-group">
                    <label for="api-endpoint"></label>
                    <div style="font-size: 12px;">
                        <a href="#" onclick="chooseApi(event, 'openai')">OpenAI</a>,
                        <!-- <a href="#" onclick="chooseApi(e, 'anthropic')">Anthropic</a>, -->
                        <a href="#" onclick="chooseApi(event, 'llamacpp')">Llama.cpp</a>
                    </div>
                </div>
                <div class="form-group">
                    <label for="api-endpoint">API Endpoint:</label>
                    <input type="text" id="api-endpoint" name="api-endpoint"
                        value="https://api.openai.com/v1/chat/completions">
                </div>
                <div class="form-group">
                    <label for="api-key">API key:</label>
                    <input type="password" id="key" name="api-key" value="" placeholder="sk-xxx-yyyyyyyzzzzzzzz" />
                </div>
                <div class="form-group">
                    <label for="model-name">Model Name:</label>
                    <input type="text" id="model-name" name="model-name" value="gpt-4o">
                </div>
                <div class="form-group">
                    <label for="prompt">App Description:</label>
                    <textarea id="prompt" name="prompt" rows="4"
                        placeholder="Describe your front-end app in a few sentences"></textarea>
                </div>
                <div class="form-group">
                    <button type="submit">Submit</button>
                </div>
            </form>
            <div class="credits">
                by <a href="https://x.com/mayfer">murat</a><br />
                clone on <a href="https://github.com/mayfer/open-artifacts">github</a>
            </div>
        </div>
        <div class="tab-section" id="tab-code">
            <pre id="code"></pre>
        </div>
        <div class="tab-section" id="tab-app">
            <iframe></iframe>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/esbuild-wasm@0.23.0"></script>
    <script>

        function openTab(tabId) {
            const tabBtn = document.getElementById(`button-${tabId}`);
            const tabSection = document.getElementById(tabId);

            document.querySelectorAll('.tab-btn').forEach(tabBtn => {
                tabBtn.classList.remove('current');
            });
            document.querySelectorAll('.tab-section').forEach(tabSection => {
                tabSection.classList.remove('current');
            });
            tabBtn.classList.add('current');
            tabSection.classList.add('current');
        }

        function chooseApi(e, api) {
            e.preventDefault();
            const apiEndpoint = document.querySelector('#api-endpoint');
            if (api == 'openai') {
                apiEndpoint.value = 'https://api.openai.com/v1/chat/completions';
            } else if (api == 'anthropic') {
                apiEndpoint.value = 'https://api.anthropic.com/v1/complete';
            } else if (api == 'llamacpp') {
                apiEndpoint.value = 'http://localhost:8080/v1/chat/completions';
            }
        }


        const form = document.getElementById('api-form');

        function saveToLocalStorage() {
            const formData = {};
            form.querySelectorAll('input, textarea').forEach(element => {
                formData[element.name] = element.value;
            });
            localStorage.setItem('apiFormData', JSON.stringify(formData));
        }

        function loadFromLocalStorage() {
            const storedData = localStorage.getItem('apiFormData');
            if (storedData) {
                const formData = JSON.parse(storedData);
                Object.keys(formData).forEach(key => {
                    const element = form.elements[key];
                    if (element) {
                        element.value = formData[key];
                    }
                });
            }
        }

        window.addEventListener('load', loadFromLocalStorage);

        form.addEventListener('input', saveToLocalStorage);

        form.addEventListener('submit', function (e) {
            e.preventDefault();
            saveToLocalStorage();
        });


        form.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                form.dispatchEvent(new Event('submit'));
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const iframeElem = document.querySelector('iframe');
            iframeElem.src = '';
                

            const prompt = form.prompt.value;
            // empty prompt
            // form.prompt.value = '';

            const fullprompt = `You are an expert front-end developer. Don't use css files, only javascript/react (jsx). You can use styled-components if you want styling. Generate a React component (called App, and render into div #root, in the same file! at the bottom) that follows the following specifications: ${prompt}\n\nQuickly list methods you'll likely need for the component(s) and then immediately generate the code in a single code block. Once code is generated, no further explanation is required. Make sure all libraries are imported (i.e. it's common to forget three.js addons), or module addons registered if needed (such as chart.js registrables).
            
            Other notes:
            * If using three.js, use appropriate device pixel ratio`;

            const apiKey = document.querySelector('#key').value;
            const apiEndpoint = document.querySelector('#api-endpoint').value;
            const modelName = document.querySelector('#model-name').value;
            const output = document.querySelector('#code');

            output.textContent = '';
            openTab('tab-code');

            const response = await fetch(apiEndpoint, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: modelName,
                    messages: [{ role: 'user', content: fullprompt }],
                    max_tokens: 4096,
                    temperature: 0,
                    stream: true
                })
            });

            if (response.ok) {
                const reader = response.body.getReader();
                const decoder = new TextDecoder('utf-8');
                let done = false;
                let responseText = '';

                let buffer = '';

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });

                    while (true) {
                        const boundary = buffer.indexOf('\n');
                        if (boundary === -1) break;

                        const chunk = buffer.slice(0, boundary).trim();
                        buffer = buffer.slice(boundary + 1);

                        if (chunk.startsWith('data: ')) {
                            const dataStr = chunk.slice(6).trim();
                            if (dataStr !== '[DONE]') {
                                try {
                                    const json = JSON.parse(dataStr);

                                    if (json.choices && json.choices.length > 0) {
                                        const content = json.choices[0].delta.content;
                                        if (content) {
                                            output.textContent += content;
                                            responseText += content;
                                            // scroll to bottom
                                            output.scrollTop = output.scrollHeight;
                                        }
                                    }

                                } catch (e) {
                                    console.error('Error parsing JSON:', e);
                                }
                            }
                        }
                    }
                }

                // Handle any remaining data in the buffer
                if (buffer.trim().startsWith('data: ')) {
                    const dataStr = buffer.trim().slice(6).trim();
                    if (dataStr !== '[DONE]') {
                        try {
                            const json = JSON.parse(dataStr);

                            if (json.choices && json.choices.length > 0) {
                                const content = json.choices[0].delta.content;
                                if (content) {
                                    output.textContent += content;
                                    responseText += content;
                                    // scroll to bottom
                                    output.scrollTop = output.scrollHeight;
                                }
                            }

                        } catch (e) {
                            console.error('Error parsing JSON:', e);
                        }
                    }
                }



                // strip ```jsx and ``` from the response
                // console.log(responseText);
                // responseText = responseText.replace(/```\w+\s*/g, '').replace(/```\s*$/g, '');

                const regex = /```(?:\w+\n)?([\s\S]*?)```/g;
                let matches;
                while ((matches = regex.exec(responseText)) !== null) {
                    responseText = matches[1].trim();
                }

                // console.log("//////////////////////");
                // console.log(responseText);

                renderGeneratedApp(responseText);

                openTab('tab-app');


            } else {
                output.textContent = 'Error: ' + response.statusText;
            }


        });



        const htmlWrapper = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon">
    <title>iFrame renderer</title>
    <style>
        body {
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/javascript">
        [[APP_CODE]]
    <\/script>
</body>
</html>
`;

        async function renderGeneratedApp(appHtml) {
            await esbuild.initialize({ wasmURL: 'https://cdn.jsdelivr.net/npm/esbuild-wasm@0.23.0/esbuild.wasm' })

            async function getLatestVersion(packageName) {
                const response = await fetch(`https://registry.npmjs.org/${packageName}`);
                const data = await response.json();
                return data['dist-tags'].latest;
            }

            const openartifactPlugin = {
                name: 'openartifact-plugin',
                setup(build) {
                    build.onResolve({ filter: /.*/ }, async (args) => {
                        if (args.path.startsWith('/')) {
                            return { path: `https://cdn.jsdelivr.net${args.path}`, namespace: 'cdn' };
                        } else {
                            const packageName = args.path;
                            try {
                                const latestVersion = await getLatestVersion(packageName);
                                return { path: `https://cdn.jsdelivr.net/npm/${packageName}@${latestVersion}/+esm`, namespace: 'cdn' };
                            } catch (error) {
                                // console.error('Error resolving package:', packageName, error);
                                return { path: `https://cdn.jsdelivr.net/npm/${packageName}/+esm`, namespace: 'cdn' };
                            }
                        }
                    });

                    build.onLoad({ filter: /^https:\/\/cdn.jsdelivr.net\// }, async (args) => {
                        const response = await fetch(args.path);
                        const contents = await response.text();
                        return { contents, loader: 'js' };
                    });
                },
            };

            try {
                const result = await esbuild.build({
                    stdin: {
                        contents: appHtml,
                        resolveDir: '',
                        loader: 'jsx',
                    },
                    outfile: 'out.js',
                    bundle: true,
                    format: 'iife',
                    minify: false,
                    keepNames: true,
                    jsx: 'automatic',
                    target: 'es2020',
                    platform: 'browser',
                    plugins: [openartifactPlugin],
                    write: false,
                })

                // console.log(result);

                const output = result.outputFiles[0].text;
                console.log('Build successful');
                // console.log(output);



                // const jsblob = new Blob([output], { type: 'text/javascript' });
                // const jsurl = URL.createObjectURL(jsblob);
                // console.log("JSURL", jsurl);

                const newAppHtml = htmlWrapper.split('[[APP_CODE]]').join(output);

                const blob = new Blob([newAppHtml], { type: 'text/html' });
                console.log("BLOB");
                console.log(output);
                const url = URL.createObjectURL(blob);

                const iframeElem = document.querySelector('iframe');
                iframeElem.src = url;
                iframeElem.onload = () => {
                    // URL.revokeObjectURL(url);
                };

            } catch (error) {
                console.error('Build failed:', error);
            } finally {
                esbuild.stop();
            }

        }

        
        openTab('tab-app');
        renderGeneratedApp(`
import React, { useEffect, useRef } from 'react';
import * as THREE from 'three';
import styled from 'styled-components';

const StyledCanvas = styled.div\`
  width: 100vw;
  height: 100vh;
  overflow: hidden;
\`;

const App = () => {
  const mountRef = useRef(null);

  useEffect(() => {
    let scene, camera, renderer;
    let playerPaddle, aiPaddle, ball;
    const paddleWidth = 1, paddleHeight = 0.2, paddleDepth = 0.2;
    const ballSize = 0.1;
    const aiSpeed = 0.02;
    const ballSpeed = new THREE.Vector3(0.02, 0.02, 0);

    const init = () => {
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.z = 5;

      renderer = new THREE.WebGLRenderer();
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(window.devicePixelRatio);
      mountRef.current.appendChild(renderer.domElement);

      playerPaddle = createPaddle(0, -2);
      aiPaddle = createPaddle(0, 2);
      ball = createBall();

      window.addEventListener('resize', handleResize);
    };

    const createPaddle = (x, y) => {
      const geometry = new THREE.BoxGeometry(paddleWidth, paddleHeight, paddleDepth);
      const material = new THREE.MeshBasicMaterial({ color: 0xffffff });
      const paddle = new THREE.Mesh(geometry, material);
      paddle.position.set(x, y, 0);
      scene.add(paddle);
      return paddle;
    };

    const createBall = () => {
      const geometry = new THREE.SphereGeometry(ballSize, 32, 32);
      const material = new THREE.MeshBasicMaterial({ color: 0xff0000 });
      const ball = new THREE.Mesh(geometry, material);
      scene.add(ball);
      return ball;
    };

    const updateBall = () => {
      ball.position.add(ballSpeed);

      if (ball.position.x <= -3 || ball.position.x >= 3) {
        ballSpeed.x = -ballSpeed.x;
      }

      if (ball.position.y <= -2 + paddleHeight / 2 && ball.position.x >= playerPaddle.position.x - paddleWidth / 2 && ball.position.x <= playerPaddle.position.x + paddleWidth / 2) {
        ballSpeed.y = -ballSpeed.y;
      }

      if (ball.position.y >= 2 - paddleHeight / 2 && ball.position.x >= aiPaddle.position.x - paddleWidth / 2 && ball.position.x <= aiPaddle.position.x + paddleWidth / 2) {
        ballSpeed.y = -ballSpeed.y;
      }
    };

    const updateAI = () => {
      if (ball.position.x > aiPaddle.position.x) {
        aiPaddle.position.x += aiSpeed;
      } else if (ball.position.x < aiPaddle.position.x) {
        aiPaddle.position.x -= aiSpeed;
      }
    };

    const animate = () => {
      requestAnimationFrame(animate);
      updateBall();
      updateAI();
      renderer.render(scene, camera);
    };

    const handleResize = () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    };

    init();
    animate();

    return () => {
      window.removeEventListener('resize', handleResize);
      mountRef.current.removeChild(renderer.domElement);
    };
  }, []);

  return <StyledCanvas ref={mountRef} />;
};

import ReactDOM from 'react-dom';

ReactDOM.render(<App />, document.getElementById('root'));`);


    </script>
</body>

</html>